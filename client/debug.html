<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connection Debug</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff00;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #00ff00;
        }
        .error { color: #ff0000; border-color: #ff0000; }
        .success { color: #00ff00; border-color: #00ff00; }
        .warning { color: #ffff00; border-color: #ffff00; }
        button {
            background: #00ff00;
            color: black;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            margin: 5px;
        }
        #log {
            background: #000;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .log-entry {
            margin: 5px 0;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üîß Connection Debugger</h1>

    <div class="status" id="network-status">
        <h3>Network Info</h3>
        <div id="network-info">Detecting...</div>
    </div>

    <div class="status" id="socket-status">
        <h3>Socket.io Connection</h3>
        <div id="socket-info">Not connected</div>
    </div>

    <div class="status" id="test-status">
        <h3>Connection Tests</h3>
        <button onclick="testHTTP()">Test HTTP</button>
        <button onclick="testWebSocket()">Test WebSocket</button>
        <button onclick="testSocketIO()">Test Socket.io</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <div class="status">
        <h3>Manual Room Join</h3>
        <input type="text" id="room-code" placeholder="Room Code" style="padding: 5px;">
        <button onclick="joinRoom()">Join Room</button>
    </div>

    <div id="log">
        <div class="log-entry">Debug log started...</div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let socket = null;
        const log = document.getElementById('log');

        function addLog(message, type = '') {
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + type;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        function clearLog() {
            log.innerHTML = '<div class="log-entry">Log cleared...</div>';
        }

        // Get network info
        async function getNetworkInfo() {
            const info = document.getElementById('network-info');

            try {
                // Get current URL info
                info.innerHTML = `
                    <div>Current URL: ${window.location.href}</div>
                    <div>Protocol: ${window.location.protocol}</div>
                    <div>Hostname: ${window.location.hostname}</div>
                    <div>Port: ${window.location.port || '80'}</div>
                `;

                // Try to get IP info
                if (window.RTCPeerConnection) {
                    const pc = new RTCPeerConnection({iceServers:[]});
                    pc.createDataChannel('');
                    pc.createOffer().then(offer => pc.setLocalDescription(offer));

                    pc.onicecandidate = (ice) => {
                        if (!ice || !ice.candidate || !ice.candidate.candidate) return;
                        const myIP = /([0-9]{1,3}\.){3}[0-9]{1,3}/.exec(ice.candidate.candidate);
                        if (myIP) {
                            info.innerHTML += `<div>Local IP: ${myIP[0]}</div>`;
                            pc.onicecandidate = () => {};
                        }
                    };
                }
            } catch (e) {
                info.innerHTML += `<div class="error">Error: ${e.message}</div>`;
            }
        }

        // Test HTTP connection
        async function testHTTP() {
            addLog('Testing HTTP connection...');

            try {
                const response = await fetch('/');
                if (response.ok) {
                    addLog('‚úÖ HTTP connection successful', 'success');
                } else {
                    addLog(`‚ö†Ô∏è HTTP response: ${response.status}`, 'warning');
                }
            } catch (e) {
                addLog(`‚ùå HTTP failed: ${e.message}`, 'error');
            }
        }

        // Test WebSocket
        function testWebSocket() {
            addLog('Testing WebSocket connection...');

            try {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const ws = new WebSocket(`${protocol}//${window.location.host}/socket.io/?EIO=4&transport=websocket`);

                ws.onopen = () => {
                    addLog('‚úÖ WebSocket connected', 'success');
                    ws.close();
                };

                ws.onerror = (e) => {
                    addLog(`‚ùå WebSocket error: ${e.message || 'Connection failed'}`, 'error');
                };

                ws.onclose = () => {
                    addLog('WebSocket closed');
                };
            } catch (e) {
                addLog(`‚ùå WebSocket failed: ${e.message}`, 'error');
            }
        }

        // Test Socket.io
        function testSocketIO() {
            addLog('Testing Socket.io connection...');

            if (socket && socket.connected) {
                socket.disconnect();
            }

            socket = io({
                transports: ['websocket', 'polling'],
                reconnection: true
            });

            const socketInfo = document.getElementById('socket-info');

            socket.on('connect', () => {
                addLog(`‚úÖ Socket.io connected: ${socket.id}`, 'success');
                socketInfo.innerHTML = `
                    <div style="color: #00ff00">Connected!</div>
                    <div>Socket ID: ${socket.id}</div>
                    <div>Transport: ${socket.io.engine.transport.name}</div>
                `;
                socketInfo.parentElement.className = 'status success';
            });

            socket.on('connect_error', (error) => {
                addLog(`‚ùå Socket.io error: ${error.message}`, 'error');
                socketInfo.innerHTML = `<div style="color: #ff0000">Connection error: ${error.message}</div>`;
                socketInfo.parentElement.className = 'status error';
            });

            socket.on('disconnect', (reason) => {
                addLog(`Socket.io disconnected: ${reason}`, 'warning');
                socketInfo.innerHTML = `<div style="color: #ffff00">Disconnected: ${reason}</div>`;
                socketInfo.parentElement.className = 'status warning';
            });
        }

        // Join room test
        function joinRoom() {
            const roomCode = document.getElementById('room-code').value.toUpperCase();
            if (!roomCode) {
                addLog('‚ùå Please enter a room code', 'error');
                return;
            }

            if (!socket || !socket.connected) {
                addLog('‚ùå Socket not connected. Test Socket.io first!', 'error');
                return;
            }

            addLog(`Attempting to join room: ${roomCode}`);

            socket.emit('join-room', {
                roomCode: roomCode,
                playerName: 'Debug Player'
            }, (response) => {
                if (response.error) {
                    addLog(`‚ùå Join failed: ${response.error}`, 'error');
                } else {
                    addLog(`‚úÖ Joined room successfully!`, 'success');
                    addLog(`Player #${response.player.number}, Color: ${response.player.color}`);
                }
            });
        }

        // Initialize
        getNetworkInfo();

        // Auto-test Socket.io
        setTimeout(() => {
            addLog('Auto-testing Socket.io connection...');
            testSocketIO();
        }, 1000);
    </script>
</body>
</html>